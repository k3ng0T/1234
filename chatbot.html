<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI –ß–∞—Ç-–±–æ—Ç | Univigate</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&family=JetBrains+Mono:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles/main.css" />
    <style>
      :root {
        --accent: #007bff;
        --accent-hover: #0056b3;
        --border: #e1e3e8;
        --text-primary: #333;
        --text-secondary: #666;
        --text-muted: #999;
        --bg: #ffffff;
        --bg-muted: #f5f7fb;
        --shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      }

      body {
        font-family: "Roboto", sans-serif;
        background: #f5f5f5;
        color: var(--text-primary);
        min-height: 100vh;
      }

      /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä-–∑–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ –≤—Å—Ç–∞–≤–∏—Ç–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç –≤ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É ‚Äî –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å */
      .chat-embed-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .chat-widget {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1000;
        font-family: "Roboto", sans-serif;
      }

      .chat-toggle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--accent);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow);
        transition: all 0.25s ease;
      }

      .chat-toggle:hover {
        background: var(--accent-hover);
        transform: translateY(-2px);
      }

      .chat-toggle svg {
        width: 26px;
        height: 26px;
        fill: #fff;
        transition: transform 0.25s ease;
      }

      .chat-toggle.active svg {
        transform: rotate(90deg);
      }

      .chat-window {
        position: absolute;
        bottom: 76px;
        right: 0;
        width: 420px;
        max-width: calc(100vw - 48px);
        height: 540px;
        background: var(--bg);
        border-radius: 18px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
        transform: translateY(16px) scale(0.98);
        transition: all 0.25s ease;
      }

      .chat-window.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
      }

      .chat-window.fullscreen {
        position: fixed;
        inset: 24px;
        width: auto;
        height: auto;
        max-width: calc(100vw - 48px);
        max-height: calc(100vh - 48px);
        border-radius: 18px;
      }

      .chat-header {
        padding: 16px 18px;
        background: var(--bg-muted);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .mode-switch {
        margin-left: auto;
        display: flex;
        gap: 8px;
      }

      .mode-btn {
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--text-secondary);
        font-size: 0.82rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .mode-btn.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      .mode-btn:hover {
        border-color: var(--accent);
      }

      .chat-avatar {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        background: linear-gradient(135deg, #4da3ff, #7c5ce0);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: #fff;
      }

      .chat-info h4 {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .chat-info span {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .chat-close {
        margin-left: auto;
        width: 34px;
        height: 34px;
        border-radius: 10px;
        background: #fff;
        border: 1px solid var(--border);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .chat-close:hover {
        background: #ffe9e9;
        border-color: #ff6b6b;
      }

      .chat-close svg {
        width: 16px;
        height: 16px;
        stroke: var(--text-secondary);
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: #fff;
      }

      .chat-messages::-webkit-scrollbar {
        width: 6px;
      }

      .chat-messages::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }

      .message {
        max-width: 85%;
        padding: 12px 14px;
        border-radius: 14px;
        font-size: 0.95rem;
        line-height: 1.5;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
      }

      .message.user {
        align-self: flex-end;
        background: linear-gradient(135deg, #4da3ff, #2f80ed);
        color: #fff;
        border-bottom-right-radius: 6px;
      }

      .message.bot {
        align-self: flex-start;
        background: #f4f7fb;
        color: var(--text-primary);
        border: 1px solid var(--border);
        border-bottom-left-radius: 6px;
      }

      .message.error {
        background: #ffecec;
        border: 1px solid #ffb3b3;
        color: #c0392b;
      }

      .message.system {
        align-self: center;
        background: transparent;
        color: var(--text-muted);
        font-size: 0.85rem;
        padding: 4px 10px;
        box-shadow: none;
      }

      .message pre {
        background: #111827;
        color: #e5e7eb;
        padding: 10px;
        border-radius: 8px;
        overflow-x: auto;
        margin-top: 10px;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.85rem;
      }

      .message code {
        font-family: "JetBrains Mono", monospace;
        background: rgba(0, 0, 0, 0.07);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.9em;
      }

      .typing-indicator {
        display: none;
        align-self: flex-start;
        padding: 12px 14px;
        background: #f4f7fb;
        border: 1px solid var(--border);
        border-radius: 14px;
        border-bottom-left-radius: 6px;
        margin-left: 16px;
        margin-bottom: 8px;
        gap: 6px;
      }

      .typing-indicator.visible {
        display: flex;
      }

      .typing-indicator span {
        width: 8px;
        height: 8px;
        background: var(--accent);
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
      }

      .typing-indicator span:nth-child(1) {
        animation-delay: 0s;
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-6px);
        }
      }

      .chat-input-area {
        padding: 14px;
        background: var(--bg-muted);
        border-top: 1px solid var(--border);
      }

      .chat-input-wrapper {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      .chat-input {
        flex: 1;
        padding: 12px 14px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        color: var(--text-primary);
        font-family: "Roboto", sans-serif;
        font-size: 0.95rem;
        outline: none;
        resize: none;
        min-height: 46px;
        max-height: 120px;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .chat-input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.12);
      }

      .chat-input::placeholder {
        color: var(--text-muted);
      }

      .chat-send {
        width: 46px;
        height: 46px;
        border-radius: 12px;
        background: var(--accent);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .chat-send:hover:not(:disabled) {
        background: var(--accent-hover);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.25);
      }

      .chat-send:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .chat-send svg {
        width: 18px;
        height: 18px;
        fill: #fff;
      }

      @media (max-width: 480px) {
        .chat-widget {
          bottom: 16px;
          right: 16px;
        }

        .chat-window {
          width: calc(100vw - 32px);
          height: calc(100vh - 120px);
          bottom: 68px;
          right: 0;
          border-radius: 16px;
        }

        .chat-toggle {
          width: 56px;
          height: 56px;
        }

        .chat-window.fullscreen {
          inset: 12px;
          max-width: calc(100vw - 24px);
          max-height: calc(100vh - 24px);
          border-radius: 14px;
        }
      }
    </style>
  </head>
  <body>
    <div class="chat-embed-wrapper"></div>

    <!-- Chat Widget -->
    <div class="chat-widget">
      <div class="chat-window" id="chatWindow">
        <div class="chat-header">
          <div class="chat-avatar">‚ú®</div>
          <div class="chat-info">
            <h4>Univigate AI</h4>
            <span>Gemini 2.5 Flash</span>
          </div>
          <div class="mode-switch">
            <button
              class="mode-btn active"
              id="modeAssistant"
              onclick="setMode('assistant')"
            >
              –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç
            </button>
            <button class="mode-btn" id="modeTest" onclick="setMode('test')">
              –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ—Å—Ç–æ–≤
            </button>
          </div>
          <button class="chat-close" onclick="toggleChat()">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="welcome-msg">
            <div class="emoji">üëã</div>
            <h3>–ü—Ä–∏–≤–µ—Ç!</h3>
            <p>–Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ –±–∞–∑–µ Gemini. –ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å!</p>
          </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
          <span></span>
          <span></span>
          <span></span>
        </div>

        <div class="chat-input-area">
          <div class="chat-input-wrapper">
            <textarea
              class="chat-input"
              id="chatInput"
              placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
              rows="1"
              onkeydown="handleKeyDown(event)"
            ></textarea>
            <button class="chat-send" id="sendBtn" onclick="sendMessage()">
              <svg viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <button class="chat-toggle" id="chatToggle" onclick="toggleChat()">
        <svg viewBox="0 0 24 24">
          <path
            d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"
          />
        </svg>
      </button>
    </div>

    <script>
      // ===== CONFIGURATION =====
      // API –∫–ª—é—á –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ GitHub Actions –ø—Ä–∏ –¥–µ–ø–ª–æ–µ
      // Placeholder –±—É–¥–µ—Ç –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á
      const API_KEY = "%%GEMINI_API_KEY%%";

      const GEMINI_API_URL =
        "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";
      let currentMode = "assistant";
      const histories = {
        assistant: [],
        test: [],
      };
      let conversationHistory = histories[currentMode];

      const SYSTEM_PROMPTS = {
        assistant: `–¢—ã - –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Univigate. 
–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏. 
–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. 
–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏.
–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –∫–æ–¥, —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–π –µ–≥–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.`,
        test: `–¢—ã ‚Äî AI-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ Univigate.
–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç tests.JSON (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤, –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è, scoring) –∫–∞–∫ –±–∞–∑—É.

–ü—Ä–∞–≤–∏–ª–∞:
1) –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞–∑–≤–∞–ª —Å—Ñ–µ—Ä—É (IT, –º–µ–¥–∏—Ü–∏–Ω–∞, –¥–∏–∑–∞–π–Ω –∏ —Ç.–ø.), —É–≥–ª—É–±–ª—è–π –≤–æ–ø—Ä–æ—Å—ã –≤ —ç—Ç–æ–π —Å—Ñ–µ—Ä–µ: —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏, –Ω–∞–≤—ã–∫–∏, —Ü–µ–Ω–Ω–æ—Å—Ç–∏, readiness-check.
2) –ï—Å–ª–∏ —Å—Ñ–µ—Ä–∞ –Ω–µ –Ω–∞–∑–≤–∞–Ω–∞ ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–π 10‚Äì15 –≤–æ–ø—Ä–æ—Å–æ–≤ (interests, skills, personality, values, real_world) —Å –±–∞–ª–∞–Ω—Å–æ–º easy/medium/hard –∏ –Ω–µ –±–æ–ª–µ–µ 1 –ø–æ—Ö–æ–∂–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.
3) –£—á–∏—Ç—ã–≤–∞–π –∫–ª–∞—Å—Å, —Ä–µ–≥–∏–æ–Ω (Almaty, Nur-Sultan, —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ), –∑–∞–ø—Ä–æ—Å –Ω–∞ STEM/–≥—É–º–∞–Ω–∏—Ç–∞—Ä–Ω—ã–π —É–∫–ª–æ–Ω.
4) –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
   - –í–æ–ø—Ä–æ—Å—ã: –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ, –∫—Ä–∞—Ç–∫–∏–µ –∏ —è—Å–Ω—ã–µ.
   - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (–ø—Ä–∏–º–µ—Ä–Ω–æ): —Ç–æ–ø-3 —Å—Ñ–µ—Ä—ã —Å % –∏ –∫–æ—Ä–æ—Ç–∫–∏–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º.
   - –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã: –ø–æ –∫–∞–∂–¥–æ–π —Å—Ñ–µ—Ä–µ 3‚Äì5 –ø—Ä–æ—Ñ–µ—Å—Å–∏–π —Å % —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è (–ø—Ä–æ—Ü–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Å—Ñ–µ—Ä—ã —Å—É–º–º–∞—Ä–Ω–æ <= 100).
   - –®–∞–≥–∏: —á—Ç–æ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ (–∫—É—Ä—Å—ã/–æ–ª–∏–º–ø–∏–∞–¥—ã/–≤—É–∑ –ø–æ —Ä–µ–≥–∏–æ–Ω—É).
5) –ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ, –±–µ–∑ –≤–æ–¥—ã.`,
      };

      function getSystemPrompt() {
        return SYSTEM_PROMPTS[currentMode];
      }

      // Check if API key is configured
      function isApiConfigured() {
        return (
          API_KEY && API_KEY !== "%%GEMINI_API_KEY%%" && API_KEY.length > 10
        );
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        autoResizeTextarea();
        renderWelcome();
        if (!isApiConfigured()) {
          console.warn("Gemini API key is not configured");
        }
      });

      function setMode(mode) {
        if (mode === currentMode) return;
        currentMode = mode;
        conversationHistory = histories[currentMode];
        document
          .getElementById("modeAssistant")
          .classList.toggle("active", mode === "assistant");
        document
          .getElementById("modeTest")
          .classList.toggle("active", mode === "test");
        renderWelcome();
        const chatWindow = document.getElementById("chatWindow");
        if (chatWindow.classList.contains("open")) {
          chatWindow.classList.toggle("fullscreen", mode === "test");
        }
        addMessage(
          `–†–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω: ${
            mode === "assistant"
              ? "–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç (–æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã)"
              : "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ—Ñ—Ç–µ—Å—Ç–æ–≤"
          }`,
          "system"
        );
      }

      function renderWelcome() {
        const messagesContainer = document.getElementById("chatMessages");
        if (currentMode === "assistant") {
          messagesContainer.innerHTML = `
              <div class="welcome-msg">
                <div class="emoji">üëã</div>
                <h3>–ü—Ä–∏–≤–µ—Ç!</h3>
                <p>–Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ –±–∞–∑–µ Gemini. –ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å!</p>
              </div>
            `;
        } else {
          messagesContainer.innerHTML = `
              <div class="welcome-msg">
                <div class="emoji">üß†</div>
                <h3>–°–æ–±—Ä–∞—Ç—å –ø—Ä–æ—Ñ—Ç–µ—Å—Ç?</h3>
                <p>–ù–∞–ø–∏—à–∏ –∫–ª–∞—Å—Å, –∏–Ω—Ç–µ—Ä–µ—Å—ã, —Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω—É–∂–Ω–æ –∏–ª–∏ —Å—Ñ–µ—Ä—É (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–∞) ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä—É—é —É–≥–ª—É–±–ª—ë–Ω–Ω—ã–π —Ç–µ—Å—Ç –∏ –ø–æ–¥—Å–∫–∞–∂—É –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏.</p>
              </div>
            `;
        }
      }

      // Toggle chat window
      function toggleChat() {
        const chatWindow = document.getElementById("chatWindow");
        const chatToggle = document.getElementById("chatToggle");

        chatWindow.classList.toggle("open");
        chatWindow.classList.toggle("fullscreen", currentMode === "test");
        chatToggle.classList.toggle("active");

        if (chatWindow.classList.contains("open")) {
          document.getElementById("chatInput").focus();
        }
      }

      // Add message to chat
      function addMessage(text, type) {
        const messagesContainer = document.getElementById("chatMessages");
        const welcomeMsg = messagesContainer.querySelector(".welcome-msg");

        if (welcomeMsg && type !== "system") {
          welcomeMsg.remove();
        }

        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;

        // Format code blocks
        let formattedText = text
          .replace(/```(\w+)?\n([\s\S]*?)```/g, "<pre><code>$2</code></pre>")
          .replace(/`([^`]+)`/g, "<code>$1</code>")
          .replace(/\n/g, "<br>");

        messageDiv.innerHTML = formattedText;
        messagesContainer.appendChild(messageDiv);

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Show/hide typing indicator
      function setTyping(show) {
        const indicator = document.getElementById("typingIndicator");
        indicator.classList.toggle("visible", show);

        if (show) {
          const messagesContainer = document.getElementById("chatMessages");
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }

      // Send message
      async function sendMessage() {
        const input = document.getElementById("chatInput");
        const sendBtn = document.getElementById("sendBtn");
        const message = input.value.trim();

        if (!message) return;

        if (!isApiConfigured()) {
          addMessage(
            "‚ö†Ô∏è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            "error"
          );
          return;
        }

        // Add user message
        addMessage(message, "user");
        input.value = "";
        input.style.height = "auto";

        // Add to history
        conversationHistory.push({
          role: "user",
          parts: [{ text: message }],
        });

        // Disable input while processing
        sendBtn.disabled = true;
        setTyping(true);

        try {
          const response = await fetch(`${GEMINI_API_URL}?key=${API_KEY}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              contents: [
                {
                  role: "user",
                  parts: [{ text: getSystemPrompt() }],
                },
                ...conversationHistory,
              ],
              generationConfig: {
                temperature: 0.7,
                topK: 40,
                topP: 0.95,
                maxOutputTokens: 2048,
              },
            }),
          });

          const data = await response.json();

          if (data.error) {
            throw new Error(data.error.message);
          }

          const botResponse = data.candidates[0].content.parts[0].text;

          // Add to history
          conversationHistory.push({
            role: "model",
            parts: [{ text: botResponse }],
          });

          // Add bot message
          setTyping(false);
          addMessage(botResponse, "bot");
        } catch (error) {
          setTyping(false);
          console.error("Error:", error);
          addMessage(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, "error");

          // Remove failed message from history
          conversationHistory.pop();
        }

        sendBtn.disabled = false;
      }

      // Handle Enter key
      function handleKeyDown(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      }

      // Auto-resize textarea
      function autoResizeTextarea() {
        const textarea = document.getElementById("chatInput");
        textarea.addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 120) + "px";
        });
      }

      // Clear chat history
      function clearChat() {
        conversationHistory = [];
        const messagesContainer = document.getElementById("chatMessages");
        messagesContainer.innerHTML = `
          <div class="welcome-msg">
            <div class="emoji">üëã</div>
            <h3>–ü—Ä–∏–≤–µ—Ç!</h3>
            <p>–Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ –±–∞–∑–µ Gemini. –ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å!</p>
          </div>
        `;
      }
      fetch("https://chatbot-gemini-worker.kengot1234567890.workers.dev", {
        method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt: "Hello!" })
  });
  console.log(response);

    </script>
  </body>
</html>
